#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# filter-packages: easily find and filter packages.yml
#
# Copyright © 2015 Chris Lamb <lamby@debian.org>
# Licensed under WTFPL — http://www.wtfpl.net/txt/copying/

import sys
import yaml
import optparse

from os.path import join, dirname, abspath

def main():
    parser = optparse.OptionParser(usage='%prog [options] [packages.yml]')
    parser.add_option('--issues', dest='issues', default=None,
        help="only print packages with comma-separated issues ISSUES")
    parser.add_option('--has-bugs', dest='bugs', action='store_true',
        help="only print packages with bug(s) listed")
    parser.add_option('--no-bugs', dest='bugs', action='store_false',
        help="only print packages without bug(s) listed")
    parser.add_option('--has-comments', dest='comments', action='store_true',
        help="only print packages with comments")
    parser.add_option('--no-comments', dest='comments', action='store_false',
        help="only print packages without comments")

    options, args = parser.parse_args()

    if len(args) > 1:
        parser.error("command can only take one argument")

    if options.issues is not None:
        options.issues = set(options.issues.split(','))

    filename = args[0] if len(args) == 1 else \
        join(dirname(dirname(abspath(__file__))), 'packages.yml')

    with open(filename) as f:
        packages = yaml.safe_load(f)

    for x, y in sorted(packages.iteritems()):
        if not options.issues <= set(y.get('issues', ())):
            continue

        if options.bugs is not None and options.bugs ^ ('bugs' in y):
            continue

        if options.comments is not None and options.comments ^ ('comments' in y):
            continue

        print x

    return 0

if __name__ == '__main__':
    sys.exit(main())
